Ext.define('Postgrado.controller.PostgradoControl', {extend: 'Ext.app.Controller',views: vistas,stores: ['Postgrados', 'Pertinencias', 'Sedes', 'Facultades', 'Departamentos', 'Archivos', 'Tipos'],models: ['Postgrado', 'Pertinencia', 'Sede', 'Facultad', 'Departamento', 'Archivo', 'Tipo'],puedeGenerar: false,refs: [{ref: 'grid', selector: 'gridpostgrado'}],init: function () {this.control({'gridpostgrado button[action=nuevo]': {click: this.nuevo},'gridpostgrado button[action=modificar]': {click: this.modificarBoton},'gridpostgrado button>menu>menuitem[action=generar]': {click: this.generarArchivo},'gridpostgradotodos button>menu>menuitem[action=generar]': {click: this.generarArchivo},'nuevopostgrado button[action=insertar]': {click: this.insertar},'nuevopostgrado button[action=subir]': {click: this.subirArhivo},'gridpostgrado': {itemdblclick: this.editar, cellkeydown: this.eliminarTecla},'editarpostgrado button[action=modificar]': {click: this.modificar},'gridpostgrado button[action=eliminar]': {click: this.eliminar},'nuevopostgrado combo[action=filtrarFacultad]': {select: this.filtrarFacultades},'nuevopostgrado combo[action=filtrarDepartamento]': {select: this.filtrarDepartamentos},'editarpostgrado combo[action=filtrarFacultad]': {select: this.filtrarFacultades},'editarpostgrado button[action=subir]': {click: this.subirArhivo},'editarpostgrado combo[action=filtrarDepartamento]': {select: this.filtrarDepartamentos},'busquedapostgrado button[action=buscar]': {click: this.buscar},'busquedapostgrado combo[action=filtrarFacultad]': {select: this.filtrarFacultades},'busquedapostgrado combo[action=filtrarDepartamento]': {select: this.filtrarDepartamentos}});},nuevo: function (button) {win = Ext.widget('nuevopostgrado');win.show(button);},insertar: function (buton) {win = buton.up('window');form = win.down('form');basicForm = form.getForm();if (basicForm.isValid()) {if (idRol !== 2)store = this.getPostgradosStore();else {store = Ext.getStore('postgradoUsuario');}valores = form.getValues();record = Ext.create('Postgrado.model.Postgrado', valores);store.add(record);win.setLoading('Insertando postgrado...');store.sync({success: function () {Ext.Msg.show({title: 'Informaci\u00f3n',msg: 'Postgrado insertada exitosamente',icon: Ext.Msg.INFO,buttons: Ext.Msg.OK});win.close();}, failure: function (action) {Ext.Msg.show({title: 'Informaci\u00f3n',msg: action.proxy.reader.jsonData.msg,icon: Ext.Msg.INFO,buttons: Ext.Msg.OK});store.rejectChanges();win.setLoading(false);}});} else  Ext.Msg.show({title: 'Informaci\u00f3n',icon: Ext.Msg.INFO,msg: 'El formulario contiene errores',buttons: Ext.Msg.OK});},editar: function (grid, record) {win = Ext.widget('editarpostgrado').show(grid);form = win.down('form');form.loadRecord(record);form.queryById('sede').select(this.getSedesStore().findRecord('idSede', record.get('departamento').facultad.sede.idSede));form.queryById('facultad').select(this.getFacultadesStore().findRecord('idFacultad', record.get('departamento').facultad.idFacultad));},modificarBoton: function (boton) {grid = boton.up('grid');seleccion = grid.getSelectionModel().getSelection();if (seleccion.length !== 0) {this.editar(grid, seleccion[0]);} else {Ext.Msg.show({title: 'Informaci\u00f3n',icon: Ext.Msg.INFO,msg: 'Para modificar debe seleccionar un registro.',buttons: Ext.Msg.OK});}},modificar: function (button) {win = button.up('window');form = win.down('form');bform = form.getForm();if (bform.isValid()) {valores = form.getValues();record = form.getRecord();record.set(valores);if (idRol !== 2)store = this.getPostgradosStore();else {store = Ext.getStore('postgradoUsuario');}if (record.dirty)win.setLoading('Modificando postgrado...');store.sync({success: function () {Ext.Msg.show({title: 'Informaci\u00f3n',msg: 'Postgrado guardado exitosamente',icon: Ext.Msg.INFO,buttons: Ext.Msg.OK});win.close();}, failure: function (action) {store.rejectChanges();Ext.Msg.show({title: 'Informaci\u00f3n',msg: action.proxy.reader.jsonData.msg,icon: Ext.Msg.INFO,buttons: Ext.Msg.OK});win.setLoading(false);}});} else {Ext.Msg.show({title: 'Informaci\u00f3n',icon: Ext.Msg.INFO,msg: 'Debe verificar los campos',buttons: Ext.Msg.OK});}},eliminar: function () {grid = this.getGrid();records = grid.getSelectionModel().getSelection();if (records.length !== 0) {if (idRol !== 2)store = this.getPostgradosStore();else {store = Ext.getStore('postgradoUsuario');}n = records.length;sp = (records.length === 1 ? ' registro' : ' registros');mensaje = 'Est\u00e1 a punto de eliminar ' + n + sp + '</br>Â¿Desea continuar?';Ext.Msg.show({title: 'Informaci\u00f3n',msg: mensaje,icon: Ext.Msg.QUESTION,buttons: Ext.Msg.OKCANCEL,buttonText: new Object({ok: "Si", cancel: "No"}),fn: function (btn) {if (btn === 'ok') {store.remove(records);np = records.length === 1;grid.setLoading('Eliminando postgrado' + (n === 1 ? '' : 's') + '...');store.sync({success: function () {grid.setLoading(false);Ext.Msg.show({title: 'Informaci\u00f3n',msg: 'Registros eliminados exitosamente',icon: Ext.Msg.INFO,buttons: Ext.Msg.OK});}, failure: function (action) {store.rejectChanges();Ext.Msg.show({title: 'Informaci\u00f3n',msg: action.proxy.reader.jsonData.msg,icon: Ext.Msg.INFO,buttons: Ext.Msg.OK});grid.setLoading(false);}});}}});} else {Ext.Msg.show({title: 'Informaci\u00f3n',msg: 'No existen filas seleccionadas',buttons: Ext.Msg.OK,icon: Ext.Msg.INFO});}},eliminarTecla: function (grid, td, cellIndex, record, tr, rowIndex, e) {if (e.getKey() === 46)this.eliminar();},subirArhivo: function (btn) {form = btn.up('form');store = this.getArchivosStore();bform = form.getForm();if (bform.isValid()) {bform.submit({url: 'archivo.do', waitMsg: 'Subiendo Archivo...', success: function (form, action) {elementos = action.result.lista;elementos.objeto = {idArchivo: elementos.idArchivo,nombre: elementos.nombre,ruta: elementos.ruta,fecha: elementos.fecha,direccion: elementos.direccion};record = Ext.create('Postgrado.model.Archivo', elementos);store.add(record);comboArchivo = Ext.getCmp('comboArchivo');comboArchivo.select(record);Ext.Msg.show({title: 'Informaci\u00f3n',icon: Ext.Msg.INFO,msg: 'Archivo Subido con Exito',buttons: Ext.Msg.OK});}, failure: function (form, action) {Ext.Msg.show({title: 'Informaci\u00f3n',icon: Ext.Msg.INFO,msg: action.result.msg,buttons: Ext.Msg.OK});}});} else {Ext.Msg.show({title: 'Informaci\u00f3n',icon: Ext.Msg.INFO,msg: 'Debe seleccionar un fichero',buttons: Ext.Msg.OK});}},filtrarFacultades: function (combo) {cbFac = combo.next();storeFac = cbFac.getStore();cbFac.clearValue();storeFac.clearFilter();storeFac.filter({filterFn: function (reg) {return reg.get('sede').idSede === combo.getValue();}});this.filtrarDepartamentos(cbFac, true);},filtrarDepartamentos: function (combo, accion) {cbDep = combo.next();cbDep.clearValue();stDep = cbDep.getStore();stDep.clearFilter();if (accion === true) {cmbSede = combo.previousSibling();stDep.filter({filterFn: function (reg) {return reg.get('facultad').sede.idSede === cmbSede.getValue();}});} else {stDep.filter({filterFn: function (reg) {return reg.get('facultad').idFacultad === combo.getValue();}});}},buscar: function (bot) {grid = bot.up('grid');form = bot.up('form');valores = form.getValues();store = grid.getStore();this.puedeGenerar = true;if (idRol === 2) {valores['usuario.idUsuario'] = idUsuario;}store.load({params: {parametros: Ext.JSON.encode(valores)}});},generarArchivo: function (item) {if (this.puedeGenerar) {form = Ext.create('Ext.form.Panel');form.submit({url: item.tipo + '/postgrado', standardSubmit: true});} else {Ext.Msg.show({title: 'Informaci\u00f3n',icon: Ext.Msg.INFO,msg: 'Debe realizar una b\u00fasqueda',buttons: Ext.Msg.OK});}}});